<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Shop Inventory System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-body: #f0f4f8; /* Light blue-gray background */
            --bg-container: #ffffff;
            --bg-section: #f8fafc; /* For input groups and saved plans list */
            --bg-planning-section: #e0f2fe; /* Light blue for planning section */
            --text-primary: #1e40af; /* Dark blue for titles/important text */
            --text-secondary: #334155; /* Medium gray for labels/general text */
            --border-color: #cbd5e1;
            --input-border-focus: #3b82f6;
            --btn-primary-bg: #3b82f6;
            --btn-primary-hover: #2563eb;
            --btn-secondary-bg: #64748b;
            --btn-secondary-hover: #475569;
            --total-cost-display-bg: #e0f2fe;
            --total-cost-display-text: #1e40af;
            --yellow-section-bg: #fffbe6; /* Light yellow */
            --yellow-section-border: #fef08a;
            --yellow-section-text: #b45309; /* Darker yellow/orange for text */
            --red-text: #ef4444;
            --red-hover-text: #dc2626;
            --green-text: #16a34a;
            --gray-subtext: #475569;
            --blue-subtext: #3b82f6;
            --blue-hover-subtext: #2563eb;
        }

        [data-theme="dark"] {
            --bg-body: #1a202c; /* Dark background */
            --bg-container: #2d3748; /* Darker container */
            --bg-section: #4a5568; /* Darker sections */
            --bg-planning-section: #334155; /* Dark blue for planning section */
            --text-primary: #e2e8f0; /* Light gray for titles/important text */
            --text-secondary: #cbd5e1; /* Lighter gray for labels/general text */
            --border-color: #718096;
            --input-border-focus: #63b3ed;
            --btn-primary-bg: #4299e1;
            --btn-primary-hover: #3182ce;
            --btn-secondary-bg: #718096;
            --btn-secondary-hover: #a0aec0;
            --total-cost-display-bg: #2b6cb0;
            --total-cost-display-text: #e2e8f0;
            --yellow-section-bg: #4a5568; /* Darker yellow for dark theme */
            --yellow-section-border: #718096;
            --yellow-section-text: #f6ad55; /* Orange for text */
            --red-text: #fc8181;
            --red-hover-text: #e53e3e;
            --green-text: #68d391;
            --gray-subtext: #a0aec0;
            --blue-subtext: #63b3ed;
            --blue-hover-subtext: #4299e1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s ease;
        }
        .container {
            background-color: var(--bg-container);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 2fr 1fr; /* Two columns on large screens */
            }
        }
        /* Adjusted colors for specific elements */
        .col-span-2.p-6.bg-blue-50 { /* Left planning column */
            background-color: var(--bg-planning-section);
            color: var(--text-secondary);
            transition: background-color 0.3s ease;
        }
        .col-span-1.p-6.bg-gray-50 { /* Right insights column */
            background-color: var(--bg-section);
            color: var(--text-secondary);
            transition: background-color 0.3s ease;
        }

        h2.text-3xl.font-bold {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        h3.text-xl.font-semibold {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        h4.text-md.font-semibold {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .input-group label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
            transition: color 0.3s ease;
        }
        .input-group input[type="date"],
        .input-group input[type="text"],
        .input-group input[type="number"],
        .ingredient-row input, .ingredient-row select {
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-container); /* Input background */
            color: var(--text-secondary); /* Input text color */
            transition: border-color 0.2s, background-color 0.3s ease, color 0.3s ease;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--input-border-focus); /* Blue focus ring */
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, color 0.3s ease;
        }
        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: white;
            border: none;
        }
        .btn-secondary:hover {
            background-color: var(--btn-secondary-hover);
            transform: translateY(-1px);
        }
        /* Specific button colors for Add Remaining Stock */
        .btn.bg-yellow-500 {
            background-color: #f59e0b; /* Tailwind yellow-500 */
        }
        .btn.bg-yellow-500:hover {
            background-color: #d97706; /* Tailwind yellow-600 */
        }

        .ingredient-row {
            background-color: var(--bg-section);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .total-cost-display {
            background-color: var(--total-cost-display-bg); /* Light blue */
            color: var(--total-cost-display-text); /* Dark blue */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Message colors */
        p.text-red-600 {
            color: var(--red-text);
        }
        p.text-green-600 {
            color: var(--green-text);
        }
        p.text-gray-500 {
            color: var(--gray-subtext);
        }

        /* Remaining Stock & Manual Add section */
        .p-4.bg-yellow-50 {
            background-color: var(--yellow-section-bg);
            border-color: var(--yellow-section-border);
            color: var(--yellow-section-text);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        h3.text-xl.font-semibold.text-yellow-800 {
            color: var(--yellow-section-text);
            transition: color 0.3s ease;
        }
        /* Adjusting text color for specific spans inside remainItem */
        .flex.justify-between.items-center.p-3.bg-gray-100.rounded-lg.shadow-sm {
            background-color: var(--bg-section);
            color: var(--text-secondary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .remainItem span.font-medium.text-gray-800 {
            color: var(--text-primary);
        }
        .remainItem span.text-gray-600 {
            color: var(--text-secondary);
        }
        
        .delete-remain-btn, .remove-ingredient-btn, .remove-product-btn {
            color: var(--red-text);
            transition: color 0.3s ease;
        }
        .delete-remain-btn:hover, .remove-ingredient-btn:hover, .remove-product-btn:hover {
            color: var(--red-hover-text);
        }

        /* Product type range search section */
        .p-4.bg-blue-50 {
            background-color: var(--bg-planning-section);
            border-color: var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        h3.text-xl.font-semibold.text-blue-800 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .clickable-header {
            color: var(--blue-subtext);
            transition: color 0.3s ease;
        }
        .clickable-header:hover {
            color: var(--blue-hover-subtext);
        }
        .bg-blue-50.border.border-blue-200.p-2.rounded-md {
            background-color: var(--bg-planning-section);
            border-color: var(--border-color);
            color: var(--text-secondary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        /* Modal specific styles */
        .modal-content {
            background-color: var(--bg-container);
            color: var(--text-secondary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal-content h3 {
            color: var(--text-primary);
        }
        .modal-content p {
            color: var(--text-secondary);
        }
        #productDetailsModal th {
            background-color: var(--bg-section);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #productDetailsModal tbody tr:nth-child(even) {
            background-color: var(--bg-planning-section);
            transition: background-color 0.3s ease;
        }
        .ingredient-list-item {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .saved-plan-item {
            background-color: var(--bg-section);
            border-color: var(--border-color);
            color: var(--text-secondary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .saved-plan-item span {
            color: var(--text-secondary);
        }

    </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-5">
    <div class="container bg-white p-8 rounded-xl shadow-lg flex flex-col lg:grid lg:grid-cols-3 gap-8">

        <!-- Theme Toggle Buttons -->
        <div class="col-span-3 flex justify-center gap-4 mb-4">
            <button id="lightThemeBtn" class="btn btn-secondary px-6 py-2">Light Theme</button>
            <button id="darkThemeBtn" class="btn btn-secondary px-6 py-2">Dark Theme</button>
        </div>

        <!-- Left Column: Weekly Planning -->
        <div class="col-span-2 p-6 bg-blue-50 rounded-xl shadow-inner">
            <h2 class="text-3xl font-bold text-blue-800 mb-6 text-center">সাপ্তাহিক উপাদানের পরিকল্পনা (Weekly Ingredient Planning)</h2>

            <!-- Date Duration Selection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="input-group">
                    <label for="startDate" class="block text-sm font-semibold text-gray-700">শুরুর তারিখ (Start Date):</label>
                    <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2">
                </div>
                <div class="input-group">
                    <label for="endDate" class="block text-sm font-semibold text-gray-700">শেষের তারিখ (End Date):</label>
                    <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2">
                </div>
            </div>

            <!-- Product and Ingredients Form -->
            <div id="productsContainer" class="space-y-6">
                <!-- Product block will be added here by JS -->
            </div>

            <button id="addProductBtn" class="w-full btn btn-secondary mt-6 py-3 px-6 rounded-lg text-lg">
                নতুন পণ্যের পরিকল্পনা যোগ করুন (Add New Product Plan)
            </button>

            <div class="total-cost-display mt-8 p-4 bg-blue-100 text-blue-900 rounded-lg text-center font-bold text-2xl">
                সপ্তাহের মোট আনুমানিক খরচ: ৳<span id="totalWeeklyCost">0.00</span> (Total Estimated Cost for Week)
            </div>

            <button id="savePlanBtn" class="w-full btn btn-primary mt-8 py-4 px-6 rounded-xl text-xl">
                সাপ্তাহিক পরিকল্পনা সংরক্ষণ করুন (Save Weekly Plan)
            </button>

            <div class="loading-spinner mt-4" id="saveSpinner"></div>
            <p id="saveMessage" class="text-center text-green-600 mt-2 hidden"></p>

            <!-- New: Saved Weekly Plans List -->
            <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">সংরক্ষিত সাপ্তাহিক পরিকল্পনা (Saved Weekly Plans)</h3>
                <div id="savedWeeklyPlansList" class="space-y-3">
                    <p class="text-gray-500 text-center" id="noSavedPlansMessage">কোনো সংরক্ষিত পরিকল্পনা পাওয়া যায়নি। (No saved plans found.)</p>
                    <!-- Saved plans will be listed here by JS -->
                </div>
            </div>

        </div>

        <!-- Right Column: Last Week's Remains & Summary -->
        <div class="col-span-1 p-6 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">অবশিষ্ট স্টক এবং অন্তর্দৃষ্টি (Remaining Stock & Insights)</h2>

            <!-- Manually Add Remaining Ingredients -->
            <div class="mb-8 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <h3 class="text-xl font-semibold text-yellow-800 mb-4">অবশিষ্ট উপাদান ম্যানুয়ালি যোগ করুন (Add Remaining Ingredients Manually)</h3>
                <div class="input-group mb-3">
                    <label for="remainsItemName" class="block text-sm font-semibold text-gray-700">উপাদানের নাম (Ingredient Name):</label>
                    <input type="text" id="remainsItemName" placeholder="যেমন, ময়দা (e.g., Flour)" class="mt-1 p-2 w-full rounded-md border-gray-300">
                </div>
                <div class="input-group mb-3">
                    <label for="remainsWeight" class="block text-sm font-semibold text-gray-700">অবশিষ্ট ওজন (Remaining Weight):</label>
                    <input type="number" id="remainsWeight" placeholder="যেমন, 500 (e.g., 500)" class="mt-1 p-2 w-full rounded-md border-gray-300">
                </div>
                <div class="input-group mb-4">
                    <label for="remainsUnit" class="block text-sm font-semibold text-gray-700">একক (Unit):</label>
                    <select id="remainsUnit" class="mt-1 p-2 w-full rounded-md border-gray-300">
                        <option value="grams">grams</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="liter">liter</option>
                        <option value="pieces">pieces</option>
                        <option value="units">units</option>
                    </select>
                </div>
                <button id="addRemainingBtn" class="w-full btn bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg">
                    অবশিষ্ট স্টক যোগ করুন (Add Remaining Stock)
                </button>
            </div>

            <!-- Display Current Remaining Ingredients -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">বর্তমান অবশিষ্ট স্টক (Current Remaining Stock)</h3>
                <div id="currentRemainsList" class="space-y-3">
                    <!-- Remaining items will be listed here by JS -->
                    <p class="text-gray-500 text-center" id="noRemainsMessage">এখনো কোনো অবশিষ্ট আইটেম যোগ করা হয়নি (No remaining items added yet).</p>
                </div>
            </div>

            <!-- Date Range Filter for Product Types -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h3 class="text-xl font-semibold text-blue-800 mb-4">পণ্যের ধরণ অনুযায়ী অনুসন্ধান (Search Product Types by Date)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="searchStartDate" class="block text-sm font-semibold text-gray-700">শুরুর তারিখ (Start Date):</label>
                        <input type="date" id="searchStartDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div class="input-group">
                        <label for="searchEndDate" class="block text-sm font-semibold text-gray-700">শেষের তারিখ (End Date):</label>
                        <input type="date" id="searchEndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-3">
                    <button id="searchProductBtn" class="flex-1 btn btn-primary py-2 px-4 rounded-lg">
                        অনুসন্ধান করুন (Search)
                    </button>
                    <button id="last10DaysBtn" class="flex-1 btn btn-secondary py-2 px-4 rounded-lg">
                        গত ১০ দিন (Last 10 Days)
                    </button>
                </div>
            </div>

            <!-- Last Week's Product Types - Now clickable for details -->
            <div>
                <h3 id="lastWeekProductTypesHeader" class="text-xl font-semibold text-gray-800 mb-4 clickable-header">
                    <span id="productTypeRangeText">গত সপ্তাহের পণ্যের ধরণ (Last Week's Product Types)</span>
                </h3>
                <div id="lastWeekProductTypes" class="space-y-2 text-gray-700">
                    <p id="noLastWeekData" class="text-gray-500 text-center">অনুসন্ধান করুন অথবা ডেটা পাওয়া যায়নি (Search or No data found).</p>
                    <!-- Last week's product types will be listed here by JS -->
                </div>
                <button id="downloadPdfBtn" class="w-full btn btn-primary mt-6 py-3 px-6 rounded-lg text-lg hidden">
                    পণ্যের বিস্তারিত তালিকা PDF ডাউনলোড করুন (Download Product Details PDF)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Remaining Ingredient Notification (reused for general messages) -->
    <div id="remainingModal" class="modal-overlay">
        <div class="modal-content">
            <h3>বার্তা (Message)</h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalYesBtn" class="btn btn-primary">হ্যাঁ (Yes)</button>
                <button id="modalNoBtn" class="btn btn-secondary">না (No)</button>
            </div>
        </div>
    </div>

    <!-- Modal for Product Details Table -->
    <div id="productDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-center mb-4">পণ্যের বিস্তারিত তালিকা (Product Details List)</h3>
            <div id="productDetailsTableContainer" class="overflow-x-auto">
                <p class="text-center text-gray-500" id="noProductDetailsData">কোনো বিস্তারিত ডেটা পাওয়া যায়নি। (No detailed data found.)</p>
            </div>
            <div class="modal-buttons mt-6">
                <button id="productDetailsModalCloseBtn" class="btn btn-primary">বন্ধ করুন (Close)</button>
            </div>
        </div>
    </div>

    <!-- jsPDF and Autotable CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Project Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFBk9pQpGvGP-U_m9YqA38Fbq-COw1xoQ",
            authDomain: "food-inventory-app-1764a.firebaseapp.com",
            projectId: "food-inventory-app-1764a",
            storageBucket: "food-inventory-app-1764a.firebasestorage.app",
            messagingSenderId: "962983280369",
            appId: "1:962983280369:web:dd86f8c2a6dcd44244b350"
        };

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default anonymous userId

        const appId = firebaseConfig.projectId; // Use projectId as appId for consistency with Firestore path

        // Global variables to store temporary data for modal interaction
        let currentModalInput = null;
        let currentRemainingDocId = null;
        let currentRemainingData = null;

        // HTML elements
        const productsContainer = document.getElementById('productsContainer');
        const addProductBtn = document.getElementById('addProductBtn');
        const savePlanBtn = document.getElementById('savePlanBtn');
        const totalWeeklyCostSpan = document.getElementById('totalWeeklyCost');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const saveSpinner = document.getElementById('saveSpinner');
        const saveMessage = document.getElementById('saveMessage');

        const remainsItemNameInput = document.getElementById('remainsItemName');
        const remainsWeightInput = document.getElementById('remainsWeight');
        const remainsUnitSelect = document.getElementById('remainsUnit');
        const addRemainingBtn = document.getElementById('addRemainingBtn');
        const currentRemainsList = document.getElementById('currentRemainsList');
        const noRemainsMessage = document.getElementById('noRemainsMessage');

        const searchStartDateInput = document.getElementById('searchStartDate');
        const searchEndDateInput = document.getElementById('searchEndDate');
        const searchProductBtn = document.getElementById('searchProductBtn');
        const last10DaysBtn = document.getElementById('last10DaysBtn');
        const lastWeekProductTypesHeader = document.getElementById('lastWeekProductTypesHeader');
        const productTypeRangeText = document.getElementById('productTypeRangeText');
        const lastWeekProductTypesDiv = document.getElementById('lastWeekProductTypes');
        const noLastWeekDataMessage = document.getElementById('noLastWeekData');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn'); // New PDF download button

        const remainingModal = document.getElementById('remainingModal');
        const modalMessage = document.getElementById('modalMessage');
        // modalYesBtn and modalNoBtn references are dynamic, retrieved within showCustomMessageBox or its callers
        // as they are re-created each time confirm buttons are needed.

        const productDetailsModal = document.getElementById('productDetailsModal');
        const productDetailsTableContainer = document.getElementById('productDetailsTableContainer');
        const noProductDetailsDataMessage = document.getElementById('noProductDetailsData');
        const productDetailsModalCloseBtn = document.getElementById('productDetailsModalCloseBtn');

        // New elements for saved weekly plans
        const savedWeeklyPlansList = document.getElementById('savedWeeklyPlansList');
        const noSavedPlansMessage = document.getElementById('noSavedPlansMessage');

        let productCount = 0; // To keep track of product blocks
        // Store the full, aggregated product data for the currently displayed range for PDF
        let currentDetailedProductsForPdf = []; 

        // Theme buttons
        const lightThemeBtn = document.getElementById('lightThemeBtn');
        const darkThemeBtn = document.getElementById('darkThemeBtn');

        // --- Firebase Initialization and Auth ---
        window.onload = async () => {
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously
                await signInAnonymously(auth);

                // Listen for auth state changes to get user ID
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('Firebase initialized and user signed in:', userId);
                        // Once authenticated, load existing data
                        loadRemainingIngredients();
                        loadSavedWeeklyPlans(); // Load saved weekly plans
                        // Load last week's data by default on app start
                        const now = new Date();
                        const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                        const twoWeeksAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 14);
                        displayProductTypesForRange(twoWeeksAgo, oneWeekAgo, 'গত সপ্তাহের পণ্যের ধরণ'); // Default last week
                    } else {
                        console.log('No user signed in after attempts, using anonymous ID fallback.');
                        userId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback if still no user
                        loadRemainingIngredients();
                        loadSavedWeeklyPlans(); // Load saved weekly plans even if auth is delayed
                        // Also attempt to load product types with a default range even if auth is delayed
                        const now = new Date();
                        const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                        const twoWeeksAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 14);
                        displayProductTypesForRange(twoWeeksAgo, oneWeekAgo, 'গত সপ্তাহের পণ্যের ধরণ');
                    }
                });

                // Add initial product planning block
                addProductBlock();
                calculateTotalWeeklyCost(); // Initial calculation

                // Apply saved theme or default to system preference
                applyThemeFromLocalStorage();
            } catch (error) {
                console.error("Error initializing Firebase or during authentication:", error);
                // Display error message to user if necessary
                saveMessage.textContent = 'অ্যাপ শুরু করতে ব্যর্থ হয়েছে। আবার চেষ্টা করুন। (Failed to initialize app. Please try again.)';
                saveMessage.classList.remove('hidden', 'text-green-600');
                saveMessage.classList.add('text-red-600');
            }
        };

        // --- Theme Switching Logic ---
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        function applyThemeFromLocalStorage() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // Default to dark theme if system preference is dark
                applyTheme('dark');
            } else {
                // Default to light theme
                applyTheme('light');
            }
        }

        lightThemeBtn.addEventListener('click', () => applyTheme('light'));
        darkThemeBtn.addEventListener('click', () => applyTheme('dark'));

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (!localStorage.getItem('theme')) { // Only react if user hasn't manually set a theme
                applyTheme(event.matches ? 'dark' : 'light');
            }
        });


        // --- Helper Functions ---

        // Formats date to Überblick-MM-DD
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Calculates the total cost for a single ingredient based on its price per unit of product
        function calculateIngredientCost(ingredientPrice, productTotalQuantity) {
            // Assuming Ingredient Price is the cost of the ingredient for ONE product unit.
            return (parseFloat(ingredientPrice) || 0) * (parseFloat(productTotalQuantity) || 0);
        }

        // Updates the total weekly cost displayed
        function calculateTotalWeeklyCost() {
            let totalCost = 0;
            // Iterate over each product block
            productsContainer.querySelectorAll('.product-block').forEach(productBlock => {
                const productTotalQuantity = productBlock.querySelector('[name="productTotalQuantity"]').value;
                let productUnitCost = 0; // Cost for one unit of this product based on its ingredients

                // Iterate over each ingredient row within the product block
                productBlock.querySelectorAll('.ingredient-row').forEach(ingredientRow => {
                    const ingredientPrice = ingredientRow.querySelector('[name="ingredientPrice"]').value;
                    productUnitCost += (parseFloat(ingredientPrice) || 0); // Sum up ingredient prices for one product unit
                });
                totalCost += (productUnitCost * (parseFloat(productTotalQuantity) || 0));
            });
            totalWeeklyCostSpan.textContent = totalCost.toFixed(2);
        }

        // --- Dynamic Form Generation ---

        function addIngredientRow(ingredientContainer, initialData = {}) {
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'ingredient-row flex flex-wrap gap-4 items-center mb-3 p-3 bg-gray-50 rounded-lg';
            ingredientRow.innerHTML = `
                <div class="flex-1 min-w-[120px]">
                    <label class="block text-sm font-medium text-gray-700 sr-only">উপাদানের নাম (Item Name)</label>
                    <input type="text" name="ingredientItemName" placeholder="উপাদানের নাম (যেমন, ময়দা)" value="${initialData.itemName || ''}"
                           class="p-2 border border-gray-300 rounded-md w-full ingredient-name-input">
                </div>
                <div class="flex-1 min-w-[80px]">
                    <label class="block text-sm font-medium text-gray-700 sr-only">ওজন (Weight)</label>
                    <input type="number" name="ingredientWeight" placeholder="ওজন (যেমন, 500)" value="${initialData.weight || ''}"
                           class="p-2 border border-gray-300 rounded-md w-full ingredient-weight-input" min="0">
                </div>
                <div class="flex-1 min-w-[70px]">
                    <label class="block text-sm font-medium text-gray-700 sr-only">একক (Unit)</label>
                    <select name="ingredientUnit" class="p-2 border border-gray-300 rounded-md w-full">
                        <option value="grams" ${initialData.unit === 'grams' ? 'selected' : ''}>grams</option>
                        <option value="kg" ${initialData.unit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="ml" ${initialData.unit === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="liter" ${initialData.unit === 'liter' ? 'selected' : ''}>liter</option>
                        <option value="pieces" ${initialData.unit === 'pieces' ? 'selected' : ''}>pieces</option>
                        <option value="units" ${initialData.unit === 'units' ? 'selected' : ''}>units</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[70px]">
                    <label class="block text-sm font-medium text-gray-700 sr-only">মূল্য (Price)</label>
                    <input type="number" name="ingredientPrice" placeholder="মূল্য (প্রতি একক)" value="${initialData.price || ''}"
                           class="p-2 border border-gray-300 rounded-md w-full ingredient-price-input" min="0" step="0.01">
                </div>
                <button type="button" class="remove-ingredient-btn text-red-500 hover:text-red-700 text-2xl font-bold p-1 leading-none transition-transform transform hover:scale-110">
                    &times;
                </button>
            `;

            ingredientContainer.appendChild(ingredientRow);

            // Add event listeners for cost calculation
            ingredientRow.querySelector('[name="ingredientPrice"]').addEventListener('input', calculateTotalWeeklyCost);
            ingredientRow.querySelector('[name="ingredientWeight"]').addEventListener('input', calculateTotalWeeklyCost); // Added this to trigger recalculation if weight changes, although for 'price per unit of product' it's not directly used in total cost.
            ingredientRow.querySelector('.remove-ingredient-btn').addEventListener('click', () => {
                ingredientRow.remove();
                calculateTotalWeeklyCost();
            });

            // Add event listener for remaining ingredient notification
            ingredientRow.querySelector('.ingredient-name-input').addEventListener('blur', (event) => {
                const enteredIngredientName = event.target.value.trim().toLowerCase();
                if (enteredIngredientName) {
                    checkRemainingIngredient(enteredIngredientName, event.target);
                }
            });

             // If it's an initial load and there's a predefined name, check for remaining automatically
             if (initialData.itemName) {
                checkRemainingIngredient(initialData.itemName.toLowerCase(), ingredientRow.querySelector('.ingredient-name-input'));
            }
        }

        function addProductBlock(initialData = {}) {
            productCount++;
            const productBlock = document.createElement('div');
            productBlock.className = 'product-block border border-blue-200 p-5 rounded-lg mb-6 bg-white shadow-sm';
            productBlock.innerHTML = `
                <h3 class="text-xl font-semibold text-blue-700 mb-4 flex justify-between items-center">
                    <span>পণ্যের পরিকল্পনা #${productCount} (Product Plan #${productCount})</span>
                    <button type="button" class="remove-product-btn text-red-500 hover:text-red-700 text-3xl font-bold leading-none transition-transform transform hover:scale-110">&times;</button>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700">পণ্যের নাম (Product Name):</label>
                        <input type="text" name="productName" placeholder="যেমন, পিজা (e.g., Pizza)" value="${initialData.productName || ''}"
                               class="mt-1 p-2 border border-gray-300 rounded-md w-full">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700">মোট পরিমাণ (সপ্তাহের জন্য) (Total Quantity (for week)):</label>
                        <input type="number" name="productTotalQuantity" placeholder="যেমন, 10 (e.g., 10)" value="${initialData.totalQuantity || ''}" min="1"
                               class="mt-1 p-2 border border-gray-300 rounded-md w-full">
                    </div>
                </div>
                <div class="ingredient-section mb-4">
                    <h4 class="text-md font-semibold text-gray-600 mb-3">উপাদান (প্রতি পণ্য একক) (Ingredients (per product unit)):</h4>
                    <div class="ingredient-container space-y-2">
                        <!-- Ingredient rows will be added here -->
                    </div>
                    <button type="button" class="add-ingredient-btn btn btn-secondary mt-3 py-2 px-4 text-sm">
                        এই পণ্যের জন্য উপাদান যোগ করুন (Add Ingredient for this Product)
                    </button>
                </div>
            `;

            productsContainer.appendChild(productBlock);

            const ingredientContainer = productBlock.querySelector('.ingredient-container');
            const addIngredientBtn = productBlock.querySelector('.add-ingredient-btn');
            const removeProductBtn = productBlock.querySelector('.remove-product-btn');
            const productTotalQuantityInput = productBlock.querySelector('[name="productTotalQuantity"]');

            // Add initial ingredient row if no initial data, or load existing ones
            if (initialData.ingredients && initialData.ingredients.length > 0) {
                initialData.ingredients.forEach(ingredient => addIngredientRow(ingredientContainer, ingredient));
            } else {
                addIngredientRow(ingredientContainer);
            }

            // Event listeners for new ingredient and product removal
            addIngredientBtn.addEventListener('click', () => addIngredientRow(ingredientContainer));
            removeProductBtn.addEventListener('click', () => {
                productBlock.remove();
                calculateTotalWeeklyCost(); // Recalculate after removing a product
            });
            productTotalQuantityInput.addEventListener('input', calculateTotalWeeklyCost); // Recalculate if quantity changes
        }

        addProductBtn.addEventListener('click', addProductBlock);

        // --- Firebase Data Operations ---

        // Function to save the weekly plan
        savePlanBtn.addEventListener('click', async () => {
            saveSpinner.classList.add('active');
            saveMessage.classList.add('hidden'); // Hide previous message

            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate || !endDate) {
                saveMessage.textContent = 'পরিকল্পনার জন্য শুরুর এবং শেষের তারিখ উভয়ই নির্বাচন করুন। (Please select both start and end dates for the plan.)';
                saveMessage.classList.remove('hidden', 'text-green-600');
                saveMessage.classList.add('text-red-600');
                saveSpinner.classList.remove('active');
                return;
            }

            const productsData = [];
            let overallTotalCost = 0; // Initialize overall total cost

            productsContainer.querySelectorAll('.product-block').forEach(productBlock => {
                const productName = productBlock.querySelector('[name="productName"]').value;
                const totalQuantity = parseInt(productBlock.querySelector('[name="productTotalQuantity"]').value);

                if (!productName || isNaN(totalQuantity) || totalQuantity <= 0) {
                    // Skip invalid product entries or show error
                    console.warn('অবৈধ পণ্য এন্ট্রি বাদ দেওয়া হচ্ছে:', productName, totalQuantity); // Skipping invalid product entry:
                    return;
                }

                const ingredients = [];
                let productUnitCost = 0; // Cost for one unit of this product

                productBlock.querySelectorAll('.ingredient-row').forEach(ingredientRow => {
                    const itemName = ingredientRow.querySelector('[name="ingredientItemName"]').value;
                    const weight = parseFloat(ingredientRow.querySelector('[name="ingredientWeight"]').value);
                    const unit = ingredientRow.querySelector('[name="ingredientUnit"]').value;
                    const price = parseFloat(ingredientRow.querySelector('[name="ingredientPrice"]').value);

                    if (itemName && !isNaN(weight) && weight >= 0 && !isNaN(price) && price >= 0) {
                        ingredients.push({ itemName, weight, unit, price });
                        productUnitCost += price; // Sum up ingredient prices for one product unit
                    }
                });

                const productTotalCost = productUnitCost * totalQuantity; // Total cost for this specific product batch
                overallTotalCost += productTotalCost; // Add to overall total cost

                productsData.push({
                    productName,
                    totalQuantity,
                    ingredients,
                    productUnitCost: productUnitCost, // Store cost for one unit of product
                    productTotalCost: productTotalCost
                });
            });

            if (productsData.length === 0) {
                saveMessage.textContent = 'অনুগ্রহ করে উপকরণ সহ অন্তত একটি বৈধ পণ্য যোগ করুন। (Please add at least one valid product with ingredients.)';
                saveMessage.classList.remove('hidden', 'text-green-600');
                saveMessage.classList.add('text-red-600');
                saveSpinner.classList.remove('active');
                return;
            }

            try {
                // Save the main weekly plan
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/weekly_plans`), {
                    startDate: new Date(startDate),
                    endDate: new Date(endDate),
                    products: productsData,
                    totalCost: overallTotalCost, // Use the calculated overallTotalCost
                    timestamp: new Date()
                });

                // Clear form after saving
                productsContainer.innerHTML = '';
                productCount = 0; // Reset product count for fresh start
                addProductBlock(); // Add a fresh product block
                startDateInput.value = '';
                endDateInput.value = '';
                calculateTotalWeeklyCost(); // Reset cost display

                saveMessage.textContent = 'সাপ্তাহিক পরিকল্পনা সফলভাবে সংরক্ষণ করা হয়েছে! (Weekly plan saved successfully!)';
                saveMessage.classList.remove('hidden', 'text-red-600');
                saveMessage.classList.add('text-green-600');

                // After saving a plan, re-load last week's data if needed (for product types)
                const now = new Date();
                const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                const twoWeeksAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 14);
                displayProductTypesForRange(twoWeeksAgo, oneWeekAgo, 'গত সপ্তাহের পণ্যের ধরণ'); // Default last week

                // Also reload the saved weekly plans list
                loadSavedWeeklyPlans();

            } catch (e) {
                console.error("নথি যোগ করতে ত্রুটি:", e); // Error adding document:
                saveMessage.textContent = 'পরিকল্পনা সংরক্ষণে ত্রুটি। আবার চেষ্টা করুন। (Error saving plan. Please try again.)';
                saveMessage.classList.remove('hidden', 'text-green-600');
                saveMessage.classList.add('text-red-600');
            } finally {
                saveSpinner.classList.remove('active');
            }
        });

        // --- Remaining Ingredients Management ---

        addRemainingBtn.addEventListener('click', async () => {
            const itemName = remainsItemNameInput.value.trim();
            const weight = parseFloat(remainsWeightInput.value);
            const unit = remainsUnitSelect.value;

            if (!itemName || isNaN(weight) || weight <= 0) {
                showCustomMessageBox('বার্তা (Message)', 'বৈধ উপাদানের নাম এবং অবশিষ্ট স্টকের জন্য ধনাত্মক ওজন প্রবেশ করান। (Please enter a valid item name and positive weight for remaining stock.)', false);
                return;
            }

            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/remaining_ingredients`), where("itemName", "==", itemName));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Item exists, update it
                    const docToUpdate = querySnapshot.docs[0];
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/remaining_ingredients`, docToUpdate.id), {
                        remainingWeight: docToUpdate.data().remainingWeight + weight, // Add to existing weight
                        timestamp: new Date()
                    });
                    showCustomMessageBox('বার্তা (Message)', `'${itemName}' এর স্টক আপডেট করা হয়েছে। (Stock for '${itemName}' updated.)`, false);
                } else {
                    // Item does not exist, add new
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/remaining_ingredients`), {
                        itemName: itemName,
                        remainingWeight: weight,
                        unit: unit,
                        timestamp: new Date()
                    });
                    showCustomMessageBox('বার্তা (Message)', `'${itemName}' অবশিষ্ট স্টকে যোগ করা হয়েছে। ( '${itemName}' added to remaining stock.)`, false);
                }

                // Clear form fields after successful addition/update
                remainsItemNameInput.value = '';
                remainsWeightInput.value = '';
                remainsUnitSelect.value = 'grams';
                // loadRemainingIngredients() is already using onSnapshot, so UI will auto-update
            } catch (e) {
                console.error("অবশিষ্ট স্টক যোগ/আপডেট করতে ত্রুটি:", e);
                showCustomMessageBox('বার্তা (Message)', 'অবশিষ্ট স্টক যোগ/আপডেট করতে ব্যর্থ হয়েছে। (Failed to add/update remaining stock.)', false);
            }
        });

        // Loads and displays remaining ingredients
        function loadRemainingIngredients() {
            if (!db || !userId) return;

            const q = collection(db, `artifacts/${appId}/users/${userId}/remaining_ingredients`);
            onSnapshot(q, (snapshot) => {
                currentRemainsList.innerHTML = ''; // Clear existing list
                if (snapshot.empty) {
                    noRemainsMessage.classList.remove('hidden');
                } else {
                    noRemainsMessage.classList.add('hidden');
                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const remainItem = document.createElement('div');
                        remainItem.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg shadow-sm';
                        // Displaying item name, weight/unit, and last updated date
                        const displayDate = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                        remainItem.innerHTML = `
                            <span class="font-medium text-gray-800">${data.itemName}</span>
                            <span class="text-gray-600">${data.remainingWeight} ${data.unit} (আপডেট: ${displayDate})</span>
                            <button data-id="${docSnap.id}" class="delete-remain-btn text-red-500 hover:text-red-700 text-lg font-bold transition-transform transform hover:scale-110">
                                &times;
                            </button>
                        `;
                        currentRemainsList.appendChild(remainItem);
                    });

                    // Add event listeners for delete buttons
                    currentRemainsList.querySelectorAll('.delete-remain-btn').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            const docId = event.target.dataset.id;
                            // Show confirmation modal before deleting
                            showCustomMessageBox(
                                'নিশ্চিত করুন (Confirm)',
                                'আপনি কি এই অবশিষ্ট উপাদানটি মুছে ফেলতে নিশ্চিত? (Are you sure you want to delete this remaining ingredient?)',
                                true // Show Yes/No buttons
                            );
                            document.getElementById('modalYesBtn').onclick = async () => {
                                try {
                                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/remaining_ingredients`, docId));
                                    showCustomMessageBox('বার্তা (Message)', 'অবশিষ্ট উপাদান সফলভাবে মুছে ফেলা হয়েছে। (Remaining ingredient deleted successfully.)', false);
                                } catch (e) {
                                    console.error("অবশিষ্ট উপাদান মুছে ফেলতে ত্রুটি:", e);
                                    showCustomMessageBox('বার্তা (Message)', 'আইটেম মুছে ফেলতে ত্রুটি হয়েছে। আবার চেষ্টা করুন। (Error deleting item. Please try again.)', false);
                                } finally {
                                    remainingModal.classList.remove('active');
                                }
                            };
                            document.getElementById('modalNoBtn').onclick = () => {
                                remainingModal.classList.remove('active');
                            };
                        });
                    });
                }
            }, (error) => {
                console.error("অবশিষ্ট উপাদান ফেচ করতে ত্রুটি:", error);
                currentRemainsList.innerHTML = `<p class="text-red-500 text-center">অবশিষ্ট আইটেম লোড করতে ত্রুটি। (Error loading remaining items.)</p>`;
            });
        }

        // Custom message box function (replaces alert())
        // `showConfirmButtons` param is true by default, if false, it shows a single close button.
        function showCustomMessageBox(title, message, showConfirmButtons = false) {
            const modalOverlay = document.getElementById('remainingModal');
            const modalContent = modalOverlay.querySelector('.modal-content');
            
            modalContent.querySelector('h3').textContent = title;
            modalContent.querySelector('#modalMessage').innerHTML = message;

            const modalButtonsDiv = modalOverlay.querySelector('.modal-buttons');
            modalButtonsDiv.innerHTML = ''; // Clear existing buttons

            if (showConfirmButtons) {
                // Re-add Yes/No buttons
                const yesBtn = document.createElement('button');
                yesBtn.id = 'modalYesBtn';
                yesBtn.className = 'btn btn-primary';
                yesBtn.textContent = 'Yes';
                modalButtonsDiv.appendChild(yesBtn);

                const noBtn = document.createElement('button');
                noBtn.id = 'modalNoBtn';
                noBtn.className = 'btn btn-secondary';
                noBtn.textContent = 'No';
                modalButtonsDiv.appendChild(noBtn);

            } else {
                // Add a single Close button
                const closeBtn = document.createElement('button');
                closeBtn.id = 'modalCloseBtn';
                closeBtn.className = 'btn btn-primary';
                closeBtn.textContent = 'Close';
                modalButtonsDiv.appendChild(closeBtn);

                closeBtn.onclick = () => {
                    modalOverlay.classList.remove('active');
                };
            }
            modalOverlay.classList.add('active');
        }


        // --- Product Type Display and Search Logic ---
        let currentProductRangeStartDate = null;
        let currentProductRangeEndDate = null;

        async function displayProductTypesForRange(startDate, endDate, rangeLabel) {
            if (!db || !userId) return;

            currentProductRangeStartDate = startDate;
            currentProductRangeEndDate = endDate;
            productTypeRangeText.textContent = `${rangeLabel} (${formatDate(startDate)} - ${formatDate(endDate)})`;

            // Clear previous content and show loading or "no data" message
            lastWeekProductTypesDiv.innerHTML = `<p class="text-gray-500 text-center">ডেটা লোড হচ্ছে... (Loading data...)</p>`;
            noLastWeekDataMessage.classList.add('hidden'); // Hide the general no data message initially
            downloadPdfBtn.classList.add('hidden'); // Hide PDF button until data is loaded

            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/weekly_plans`),
                where("startDate", ">=", startDate),
                where("startDate", "<=", endDate) // Use <= for endDate to include plans starting on the end date
            );

            onSnapshot(q, (snapshot) => {
                lastWeekProductTypesDiv.innerHTML = ''; // Clear previous content
                const productNames = new Set();
                let hasData = false;
                currentDetailedProductsForPdf = []; // Reset stored data for PDF

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.products && Array.isArray(data.products)) {
                        data.products.forEach(product => {
                            if (product.productName) {
                                productNames.add(product.productName);
                                hasData = true;
                            }
                            // Aggregate quantities and costs for products with the same name across different plans for PDF data
                            const existingProduct = currentDetailedProductsForPdf.find(p => p.productName === product.productName);
                            if (existingProduct) {
                                existingProduct.totalQuantity += (product.totalQuantity || 0);
                                existingProduct.productTotalCost += (product.productTotalCost || 0);
                                // For ingredients, if same product name, we assume same ingredients per unit.
                                // If ingredients can differ for same named products, a more complex merge/list is needed.
                                // For simplicity here, we'll keep the ingredients from the first found product.
                            } else {
                                currentDetailedProductsForPdf.push({ ...product }); // Add a copy of the product data
                            }
                        });
                    }
                });

                if (hasData) {
                    noLastWeekDataMessage.classList.add('hidden');
                    productNames.forEach(name => {
                        const p = document.createElement('p');
                        p.className = 'bg-blue-50 border border-blue-200 p-2 rounded-md';
                        p.textContent = name;
                        lastWeekProductTypesDiv.appendChild(p);
                    });
                    downloadPdfBtn.classList.remove('hidden'); // Show PDF button if data exists
                } else {
                    noLastWeekDataMessage.classList.remove('hidden');
                    lastWeekProductTypesDiv.innerHTML = ''; // Ensure no items are shown if empty
                    downloadPdfBtn.classList.add('hidden'); // Hide PDF button if no data
                }
            }, (error) => {
                console.error("পণ্যের ধরণ ফেচ করতে ত্রুটি:", error);
                lastWeekProductTypesDiv.innerHTML = `<p class="text-red-500 text-center">ডেটা লোড করতে ত্রুটি। (Error loading data.)</p>`;
                downloadPdfBtn.classList.add('hidden'); // Hide PDF button on error
            });
        }

        // Event listener for custom date range search
        searchProductBtn.addEventListener('click', () => {
            const searchStartDate = searchStartDateInput.value;
            const searchEndDate = searchEndDateInput.value;

            if (!searchStartDate || !searchEndDate) {
                showCustomMessageBox('Message', 'Please select both start and end dates for the search.', false);
                return;
            }

            const sDate = new Date(searchStartDate);
            const eDate = new Date(searchEndDate);
            displayProductTypesForRange(sDate, eDate, 'Search Results');
        });

        // Event listener for "Last 10 Days" button
        last10DaysBtn.addEventListener('click', () => {
            const now = new Date();
            const tenDaysAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 10);
            displayProductTypesForRange(tenDaysAgo, now, 'Last 10 Days Product Types');
            searchStartDateInput.value = formatDate(tenDaysAgo);
            searchEndDateInput.value = formatDate(now);
        });

        // Event listener to open product details modal when header is clicked
        lastWeekProductTypesHeader.addEventListener('click', () => {
            // Use the currently displayed range for the detailed view
            if (currentProductRangeStartDate && currentProductRangeEndDate) {
                openProductDetailsModal(currentProductRangeStartDate, currentProductRangeEndDate);
            } else {
                showCustomMessageBox('Message', 'Please select a date range first to view detailed data.', false);
            }
        });

        productDetailsModalCloseBtn.addEventListener('click', () => {
            productDetailsModal.classList.remove('active');
        });

        // Function to open and populate the product details modal
        async function openProductDetailsModal(startDate, endDate) {
            if (!db || !userId) return;

            productDetailsTableContainer.innerHTML = `<p class="text-center text-gray-500">Loading data...</p>`;
            noProductDetailsDataMessage.classList.add('hidden');

            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/weekly_plans`),
                where("startDate", ">=", startDate),
                where("startDate", "<=", endDate)
            );

            try {
                const querySnapshot = await getDocs(q); // Use getDocs for a one-time fetch for the modal

                const productsToShow = [];

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.products && Array.isArray(data.products)) {
                        // Aggregate quantities and costs for products with the same name across different plans
                        data.products.forEach(product => {
                            const existingProduct = productsToShow.find(p => p.productName === product.productName);
                            if (existingProduct) {
                                existingProduct.totalQuantity += (product.totalQuantity || 0);
                                existingProduct.productTotalCost += (product.productTotalCost || 0);
                                // For ingredients, if same product name, we assume same ingredients per unit.
                                // If ingredients can differ for same named products, a more complex merge/list is needed.
                                // For simplicity here, we'll keep the ingredients from the first found product.
                            } else {
                                productsToShow.push({ ...product }); // Add a copy of the product data
                            }
                        });
                    }
                });

                if (productsToShow.length > 0) {
                    noProductDetailsDataMessage.classList.add('hidden');
                    let tableHTML = `
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Total Quantity</th>
                                    <th>Total Cost</th>
                                    <th>Ingredients List</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    productsToShow.forEach(product => {
                        let ingredientsListHtml = '';
                        if (product.ingredients && Array.isArray(product.ingredients) && product.ingredients.length > 0) {
                            ingredientsListHtml = product.ingredients.map(ing =>
                                `<div class="ingredient-list-item">${ing.itemName}: ${ing.weight} ${ing.unit} (৳${ing.price.toFixed(2)})</div>`
                            ).join('');
                        } else {
                            ingredientsListHtml = `<div class="ingredient-list-item">No ingredients.</div>`;
                        }

                        tableHTML += `
                            <tr>
                                <td>${product.productName}</td>
                                <td>${product.totalQuantity}</td>
                                <td>৳${product.productTotalCost.toFixed(2)}</td>
                                <td>${ingredientsListHtml}</td>
                            </tr>
                        `;
                    });
                    tableHTML += `</tbody></table>`;
                    productDetailsTableContainer.innerHTML = tableHTML;
                } else {
                    noProductDetailsDataMessage.classList.remove('hidden');
                    productDetailsTableContainer.innerHTML = '';
                }

                productDetailsModal.classList.add('active'); // Show the modal
            } catch (error) {
                console.error("Error fetching product details data:", error);
                productDetailsTableContainer.innerHTML = `<p class="text-red-500 text-center">Error loading detailed data.</p>`;
                noProductDetailsDataMessage.classList.add('hidden'); // Hide the generic no data message
                productDetailsModal.classList.add('active'); // Still show modal, but with error
            }
        }

        // --- Saved Weekly Plans Management (New Functionality) ---
        function loadSavedWeeklyPlans() {
            if (!db || !userId) return;

            const q = collection(db, `artifacts/${appId}/users/${userId}/weekly_plans`);
            onSnapshot(q, (snapshot) => {
                savedWeeklyPlansList.innerHTML = ''; // Clear existing list
                if (snapshot.empty) {
                    noSavedPlansMessage.classList.remove('hidden');
                } else {
                    noSavedPlansMessage.classList.add('hidden');
                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const planItem = document.createElement('div');
                        planItem.className = 'saved-plan-item';
                        const startDateStr = data.startDate ? new Date(data.startDate.seconds * 1000).toLocaleDateString() : 'N/A';
                        const endDateStr = data.endDate ? new Date(data.endDate.seconds * 1000).toLocaleDateString() : 'N/A';
                        const totalCostStr = data.totalCost ? `৳${data.totalCost.toFixed(2)}` : '৳0.00';

                        planItem.innerHTML = `
                            <span>${startDateStr} - ${endDateStr} (${totalCostStr})</span>
                            <button data-id="${docSnap.id}" class="delete-plan-btn">
                                &times;
                            </button>
                        `;
                        savedWeeklyPlansList.appendChild(planItem);
                    });

                    // Add event listeners for delete buttons
                    savedWeeklyPlansList.querySelectorAll('.delete-plan-btn').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            const docId = event.target.dataset.id;
                            // Show confirmation modal before deleting
                            showCustomMessageBox(
                                'Confirm',
                                'Are you sure you want to delete this weekly plan?',
                                true // Show Yes/No buttons
                            );
                            document.getElementById('modalYesBtn').onclick = async () => {
                                try {
                                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/weekly_plans`, docId));
                                    showCustomMessageBox('Message', 'Weekly plan deleted successfully.', false);
                                } catch (e) {
                                    console.error("Error deleting weekly plan:", e);
                                    showCustomMessageBox('Message', 'Error deleting plan. Please try again.', false);
                                } finally {
                                    remainingModal.classList.remove('active');
                                }
                            };
                            document.getElementById('modalNoBtn').onclick = () => {
                                remainingModal.classList.remove('active');
                            };
                        });
                    });
                }
            }, (error) => {
                console.error("Error fetching saved weekly plans:", error);
                savedWeeklyPlansList.innerHTML = `<p class="text-red-500 text-center">Error loading plans.</p>`;
            });
        }

        // --- Check Remaining Ingredient (POPUP Logic) ---
        async function checkRemainingIngredient(itemName, inputElement) {
            if (!db || !userId) return;
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/remaining_ingredients`), where("itemName", "==", itemName));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const remainingDocSnap = querySnapshot.docs[0];
                    currentRemainingData = remainingDocSnap.data(); // Store the data
                    currentRemainingDocId = remainingDocSnap.id; // Store the document ID
                    currentModalInput = inputElement; // Store reference to the input field

                    // Simplified message
                    const message = `আপনার ইনভেন্টরিতে <strong>${currentRemainingData.itemName}</strong> এর অবশিষ্ট স্টক আছে। আপনি কি এই প্ল্যানে এটি ব্যবহার করতে চান এবং ইনভেন্টরি থেকে অ্যাডজাস্ট করতে চান? (You have remaining stock of <strong>${currentRemainingData.itemName}</strong> in your inventory. Do you want to use it for this plan and adjust from inventory?)`;
                    
                    showCustomMessageBox('বার্তা (Message)', message, true); // Pass the simplified message

                    // Set up event handlers for the dynamically created Yes/No buttons
                    document.getElementById('modalYesBtn').onclick = async () => {
                        try {
                            if (currentModalInput && currentRemainingData && currentRemainingDocId) {
                                // Set the input field value to the remaining quantity
                                // Assuming the inputElement is the quantity/weight input for the ingredient
                                const weightInput = currentModalInput.closest('.ingredient-row').querySelector('[name="ingredientWeight"]');
                                if (weightInput) {
                                    weightInput.value = currentRemainingData.remainingWeight;
                                    weightInput.dispatchEvent(new Event('input')); // Trigger input event to recalculate cost
                                } else {
                                    // Fallback if weightInput not found (e.g., if inputElement was itemName field)
                                    currentModalInput.value = currentRemainingData.remainingWeight;
                                    currentModalInput.dispatchEvent(new Event('input'));
                                }
                                

                                // Delete the remaining ingredient from Firestore
                                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/remaining_ingredients`, currentRemainingDocId));
                                
                                showCustomMessageBox('বার্তা (Message)', `প্ল্যানে '${currentRemainingData.itemName}' যোগ করা হয়েছে এবং ইনভেন্টরি থেকে ব্যবহার করা হয়েছে। ( '${currentRemainingData.itemName}' added to plan and consumed from inventory.)`, false);
                            }
                        } catch (e) {
                            console.error("Error consuming remaining ingredient:", e);
                            showCustomMessageBox('বার্তা (Message)', 'ইনভেন্টরি থেকে উপাদান ব্যবহার করতে ব্যর্থ। (Failed to consume ingredient from inventory.)', false);
                        } finally {
                            remainingModal.classList.remove('active');
                            currentModalInput = null; // Clear global references
                            currentRemainingDocId = null;
                            currentRemainingData = null;
                        }
                    };

                    document.getElementById('modalNoBtn').onclick = () => {
                        remainingModal.classList.remove('active');
                        currentModalInput = null; // Clear global references
                        currentRemainingDocId = null;
                        currentRemainingData = null;
                    };

                }
            } catch (e) {
                console.error("Error checking remaining ingredient:", e);
                // Optionally show a message to the user about the error, but usually silent for this check
            }
        }

        // --- PDF Generation Logic ---
        downloadPdfBtn.addEventListener('click', async () => {
            // Add debugging logs
            console.log('Attempting PDF download...');
            console.log('currentProductRangeStartDate:', currentProductRangeStartDate);
            console.log('currentProductRangeEndDate:', currentProductRangeEndDate);
            console.log('currentDetailedProductsForPdf content:', currentDetailedProductsForPdf); 

            if (!currentProductRangeStartDate || !currentProductRangeEndDate || currentDetailedProductsForPdf.length === 0) {
                showCustomMessageBox('Message', 'Please select a date range and load data to download PDF.', false);
                return;
            }

            const doc = new window.jspdf.jsPDF(); // Access jsPDF from window object
            const startStr = formatDate(currentProductRangeStartDate);
            const endStr = formatDate(currentProductRangeEndDate);

            // PDF Title
            doc.setFontSize(16);
            doc.text(`Product Details List`, 14, 20);
            doc.setFontSize(12);
            doc.text(`For Dates: ${startStr} - ${endStr}`, 14, 28);


            const tableColumn = [
                "Product Name",
                "Total Quantity",
                "Total Cost",
                "Ingredients List"
            ];
            const tableRows = [];

            currentDetailedProductsForPdf.forEach(product => {
                let ingredientsListText = '';
                if (product.ingredients && Array.isArray(product.ingredients) && product.ingredients.length > 0) {
                    ingredientsListText = product.ingredients.map(ing =>
                        `${ing.itemName}: ${ing.weight} ${ing.unit} (৳${ing.price.toFixed(2)})`
                    ).join('\n'); // Use newline for ingredients list
                } else {
                    ingredientsListText = `No ingredients.`;
                }

                tableRows.push([
                    product.productName,
                    product.totalQuantity.toString(),
                    `৳${product.productTotalCost.toFixed(2)}`,
                    ingredientsListText
                ]);
            });

            if (tableRows.length > 0) {
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 40, // Start table lower to accommodate title
                    styles: {
                        font: 'Helvetica', // Using Helvetica for better compatibility with non-latin characters
                        fontStyle: 'normal',
                        fontSize: 9,
                        cellPadding: 3,
                        lineColor: 200, // Light grey borders
                        lineWidth: 0.1,
                        textColor: [51, 65, 85]
                    },
                    headStyles: {
                        fillColor: [240, 244, 248], // Light blue-gray background for header
                        textColor: [51, 65, 85], // Darker gray text
                        fontStyle: 'bold',
                        halign: 'center' // Center header text
                    },
                    columnStyles: {
                        0: {cellWidth: 'auto'}, // Product Name
                        1: {cellWidth: 60, halign: 'center'}, // Total Quantity
                        2: {cellWidth: 60, halign: 'right'}, // Total Cost
                        3: {cellWidth: 'auto'} // Ingredients List (will expand)
                    },
                    didDrawCell: data => {
                        // For Ingredients List column, ensure proper line breaks
                        if (data.column.index === 3 && data.cell.text) {
                            // autoTable generally handles newlines, but this hook can be used for custom rendering if needed
                            // For now, it's illustrative; default autoTable handling is often sufficient.
                        }
                    }
                });

                doc.save(`Product_Details_${startStr}_to_${endStr}.pdf`);
                showCustomMessageBox('Message', 'Product details list PDF downloaded successfully.', false);
            } else {
                showCustomMessageBox('Message', 'No detailed data for this date range.', false);
            }
        });

    </script>
</body>
</html>
